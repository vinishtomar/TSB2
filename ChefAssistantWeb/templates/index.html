<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de Chantier - Centrale au Sol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f6f8fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-header {
            background: linear-gradient(90deg, #4a90e2, #357abd);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.5rem; 
            font-weight: 600; 
        }
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .action-btn { /* Combined logout-btn and new admin-btn style */
            background: #eaf1fb;
            color: #357abd;
            border: none;
            border-radius: 0.5rem;
            padding: 0.4rem 0.8rem;
            font-weight: 500;
            text-decoration: none;
            transition: background .2s, color .2s;
            font-size: 0.9rem;
        }
        .action-btn:hover {
            background: #d1e0f1;
            color: #2c699d;
        }
        .rounded-card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            margin-bottom: 1.5rem;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }
        .nav-tabs .nav-link {
            color: #4a90e2;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #357abd;
            border-color: #dee2e6 #dee2e6 #fff;
            border-bottom-color: #357abd; /* Emphasize active tab bottom border */
            border-bottom-width: 3px;
        }
        .subnav .nav-link {
            border-radius: 30px !important;
            margin-right: .5rem;
            color: #357abd;
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
        }
        .subnav .nav-link.active {
            background: #357abd !important;
            color: white !important;
        }
        .table thead th {
            background-color: #4a90e2;
            color: white;
            font-size: 0.9rem;
            white-space: nowrap;
            padding: 0.6rem 0.5rem;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .table td, .table th {
            vertical-align: middle !important;
            padding: 0.6rem 0.5rem;
        }
        .nowrap { white-space: nowrap; }
        .history-table { font-size: 0.85rem; overflow-x: auto; }
        .modify-btn { /* Style for both modify and delete buttons in tables */
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            margin-left: 0.25rem; /* Space between buttons */
        }
        .form-label { font-weight: 500; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .form-control, .form-select { font-size: 0.9rem; border-radius: 0.4rem; }
        .btn-primary { background-color: #357abd; border-color: #357abd; }
        .btn-primary:hover { background-color: #2c699d; border-color: #2c699d; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .alert { border-radius: 0.5rem; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-title">
           <span style="font-size:1.5rem;">ðŸŒž</span>
           Suivi de Chantier - Centrale au Sol
        </div>
        <div class="header-actions">
            {% if current_user and current_user.is_authenticated and current_user.role == "admin" %}
                <a href="{{ url_for('admin_panel') }}" class="action-btn">Panneau Admin</a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="action-btn">DÃ©connexion</a>
        </div>
    </header>

    <div class="container-fluid pt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    </div>

    <ul class="nav nav-tabs px-4 pt-3" id="mainTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="reception-tab" data-bs-toggle="tab" data-bs-target="#reception" type="button" role="tab" aria-controls="reception" aria-selected="true">RÃ©ception Chantier</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="avancement-tab" data-bs-toggle="tab" data-bs-target="#avancement" type="button" role="tab" aria-controls="avancement" aria-selected="false">Avancement Chantier</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="fin-tab" data-bs-toggle="tab" data-bs-target="#fin" type="button" role="tab" aria-controls="fin" aria-selected="false">Fin Chantier</button>
      </li>
      {% if current_user and current_user.is_authenticated and current_user.role == "admin" %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">Historique</button>
      </li>
      {% endif %}
    </ul>

    <div class="tab-content container-fluid pt-4" id="mainTabContent">
      <div class="tab-pane fade show active" id="reception" role="tabpanel" aria-labelledby="reception-tab">
        <div class="card rounded-card">
          <div class="card-body">
            <div class="card-title">RÃ©ception du Chantier</div>
            <ul class="nav subnav nav-pills mb-4" id="receptionSubTab" role="tablist">
              <li class="nav-item" role="presentation"><button class="nav-link active" id="equipements-tab" data-bs-toggle="pill" data-bs-target="#equipements" type="button" role="tab">Ã‰quipements</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="connecteur-tab" data-bs-toggle="pill" data-bs-target="#connecteur" type="button" role="tab">Connecteur</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="chemin-cable-tab" data-bs-toggle="pill" data-bs-target="#chemin-cable" type="button" role="tab">Chemin de CÃ¢ble</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="terre-tab" data-bs-toggle="pill" data-bs-target="#terre" type="button" role="tab">Terre</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="cable-ac-tab" data-bs-toggle="pill" data-bs-target="#cable-ac" type="button" role="tab">CÃ¢ble AC</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="cable-dc-tab" data-bs-toggle="pill" data-bs-target="#cable-dc" type="button" role="tab">CÃ¢ble DC</button></li>
            </ul>
            <div class="tab-content" id="receptionSubTabContent">
              <div class="tab-pane fade show active" id="equipements" role="tabpanel">
                <form method="POST" action="{{ url_for('suivi_journalier') }}" enctype="multipart/form-data">
                  <div class="row mb-2 fw-bold text-center"><div class="col-md-3">Type</div><div class="col-md-3">RÃ©fÃ©rence</div><div class="col-md-2">Ã‰tat</div><div class="col-md-2">Date RÃ©ception</div><div class="col-md-2">Nombre</div></div>
                  <div class="row mb-2 align-items-center">
                    <div class="col-md-3"><select class="form-select" name="equipement_type_1"><option value="">SÃ©lectionner...</option><option value="Nacelle ciseau">Nacelle ciseau</option><option value="Nacelle Ã  bras">Nacelle Ã  bras</option><option value="Manitou">Manitou</option></select></div>
                    <div class="col-md-3"><input type="text" class="form-control" name="equipement_reference_1" placeholder="NumÃ©ro de sÃ©rie"></div>
                    <div class="col-md-2"><select class="form-select" name="equipement_etat_1"><option value="Bon Ã©tat">Bon Ã©tat</option><option value="Ã€ vÃ©rifier">Ã€ vÃ©rifier</option><option value="DÃ©faillant">DÃ©faillant</option></select></div>
                    <div class="col-md-2"><input type="date" class="form-control" name="equipement_date_reception_1"></div>
                    <div class="col-md-2"><input type="number" class="form-control" name="equipement_nombre_1" min="0" placeholder="QtÃ©"></div>
                  </div>
                  <div class="row mb-2 align-items-center">
                    <div class="col-md-3"><select class="form-select" name="equipement_type_2"><option value="">SÃ©lectionner...</option><option value="Nacelle ciseau">Nacelle ciseau</option><option value="Nacelle Ã  bras">Nacelle Ã  bras</option><option value="Manitou">Manitou</option></select></div>
                    <div class="col-md-3"><input type="text" class="form-control" name="equipement_reference_2" placeholder="NumÃ©ro de sÃ©rie"></div>
                    <div class="col-md-2"><select class="form-select" name="equipement_etat_2"><option value="Bon Ã©tat">Bon Ã©tat</option><option value="Ã€ vÃ©rifier">Ã€ vÃ©rifier</option><option value="DÃ©faillant">DÃ©faillant</option></select></div>
                    <div class="col-md-2"><input type="date" class="form-control" name="equipement_date_reception_2"></div>
                    <div class="col-md-2"><input type="number" class="form-control" name="equipement_nombre_2" min="0" placeholder="QtÃ©"></div>
                  </div>
                  <div class="row mb-3 align-items-center">
                    <div class="col-md-3"><select class="form-select" name="equipement_type_3"><option value="">SÃ©lectionner...</option><option value="Nacelle ciseau">Nacelle ciseau</option><option value="Nacelle Ã  bras">Nacelle Ã  bras</option><option value="Manitou">Manitou</option></select></div>
                    <div class="col-md-3"><input type="text" class="form-control" name="equipement_reference_3" placeholder="NumÃ©ro de sÃ©rie"></div>
                    <div class="col-md-2"><select class="form-select" name="equipement_etat_3"><option value="Bon Ã©tat">Bon Ã©tat</option><option value="Ã€ vÃ©rifier">Ã€ vÃ©rifier</option><option value="DÃ©faillant">DÃ©faillant</option></select></div>
                    <div class="col-md-2"><input type="date" class="form-control" name="equipement_date_reception_3"></div>
                    <div class="col-md-2"><input type="number" class="form-control" name="equipement_nombre_3" min="0" placeholder="QtÃ©"></div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Photos des Ã©quipements</label>
                    <div id="photos-container-equipements">
                      <div class="input-group mb-2">
                        <input type="file" class="form-control" name="photo_chantier[]" accept="image/*">
                        <button class="btn btn-danger remove-photo-btn-equipements" type="button" style="display:none;">Supprimer</button> 
                      </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm mt-2" id="add-photo-btn-equipements">Ajouter une autre photo</button>
                  </div>

                  <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer Ã‰quipements</button></div>
                </form>
              </div>
              <div class="tab-pane fade" id="connecteur" role="tabpanel">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                    <div class="row mb-3">
                      <div class="col-md-4"><label class="form-label">Type de connecteur</label><input type="text" class="form-control" name="connecteur_type"></div>
                      <div class="col-md-4"><label class="form-label">QuantitÃ©</label><input type="number" class="form-control" name="connecteur_quantite" min="0"></div>
                      <div class="col-md-4"><label class="form-label">Ã‰tat</label><select class="form-select" name="connecteur_etat"><option value="Bon Ã©tat">Bon Ã©tat</option><option value="Ã€ vÃ©rifier">Ã€ vÃ©rifier</option><option value="DÃ©faillant">DÃ©faillant</option></select></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer Connecteur</button></div>
                </form>
              </div>
              <div class="tab-pane fade" id="chemin-cable" role="tabpanel">
                 <form method="POST" action="{{ url_for('suivi_journalier') }}">
                    <div class="row mb-3">
                      <div class="col-md-3"><label class="form-label">Type de chemin</label><input type="text" class="form-control" name="chemin_cable_type" placeholder="Ex: Fourreau, Caniveau"></div>
                      <div class="col-md-3"><label class="form-label">Longueur (m)</label><input type="number" step="0.1" class="form-control" name="chemin_cable_longueur" min="0"></div>
                      <div class="col-md-3"><label class="form-label">Section (mmÂ²)</label><input type="text" class="form-control" name="chemin_cable_section" placeholder="Ex: 50x100"></div>
                      <div class="col-md-3"><label class="form-label">Profondeur (cm)</label><input type="number" step="0.1" class="form-control" name="chemin_cable_profondeur" min="0"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer Chemin de CÃ¢ble</button></div>
                </form>
              </div>
              <div class="tab-pane fade" id="terre" role="tabpanel">
                 <form method="POST" action="{{ url_for('suivi_journalier') }}">
                    <div class="row mb-3">
                     <div class="col-md-6"><label class="form-label">Longueur CÃ¢ble de Terre (m)</label><input type="number" step="0.1" class="form-control" name="terre_longueur" min="0"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer Terre</button></div>
                </form>
              </div>
              <div class="tab-pane fade" id="cable-ac" role="tabpanel">
                 <form method="POST" action="{{ url_for('suivi_journalier') }}">
                    <div class="row mb-3">
                     <div class="col-md-6"><label class="form-label">Section CÃ¢ble AC (mmÂ²)</label><input type="text" class="form-control" name="cableac_section"></div>
                     <div class="col-md-6"><label class="form-label">Longueur CÃ¢ble AC (m)</label><input type="number" step="0.1" class="form-control" name="cableac_longueur" min="0"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer CÃ¢ble AC</button></div>
                </form>
              </div>
               <div class="tab-pane fade" id="cable-dc" role="tabpanel">
                 <form method="POST" action="{{ url_for('suivi_journalier') }}">
                    <div class="row mb-3">
                     <div class="col-md-4"><label class="form-label">Section CÃ¢ble DC (mmÂ²)</label><input type="text" class="form-control" name="cabledc_section"></div>
                     <div class="col-md-4"><label class="form-label">Longueur CÃ¢ble DC (m)</label><input type="number" step="0.1" class="form-control" name="cabledc_longueur" min="0"></div>
                     <div class="col-md-4"><label class="form-label">Nombre de Shelter</label><input type="number" class="form-control" name="shelter_nombre" min="0"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer CÃ¢ble DC</button></div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="avancement" role="tabpanel" aria-labelledby="avancement-tab">
        <div class="card rounded-card">
          <div class="card-body">
            <div class="card-title">Avancement du Chantier</div>
            <form method="POST" action="{{ url_for('suivi_journalier') }}">
                <div class="row mb-3">
                    <div class="col-md-4"><label class="form-label">CÃ¢bles DC TirÃ©s (m)</label><input type="number" step="0.1" class="form-control" name="cables_dctires" min="0"></div>
                    <div class="col-md-4"><label class="form-label">CÃ¢bles AC TirÃ©s (m)</label><input type="number" step="0.1" class="form-control" name="cables_actires" min="0"></div>
                    <div class="col-md-4"><label class="form-label">CÃ¢bles Terre TirÃ©s (m)</label><input type="number" step="0.1" class="form-control" name="cables_terretires" min="0"></div>
                </div>
                <div class="mb-3"><label class="form-label">ProblÃ¨mes RencontrÃ©s / Observations</label><textarea class="form-control" name="problems" rows="4" placeholder="DÃ©crivez les problÃ¨mes ou observations..."></textarea></div>
                <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer Avancement</button></div>
            </form>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="fin" role="tabpanel" aria-labelledby="fin-tab">
          <div class="card rounded-card">
              <div class="card-body">
                <div class="card-title">Fin du Chantier (Tests et Mesures)</div>
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                    <div class="table-responsive">
                        <table class="table align-middle table-sm"> 
                            <thead><tr><th>Zone</th><th>String</th><th>Tension DC (V)</th><th>Courant DC (A)</th><th>Tension AC (V)</th><th>Puissance (W)</th><th>Date Mesure</th><th>Technicien</th><th>Statut</th></tr></thead>
                            <tbody><tr>
                                <td><input type="text" class="form-control form-control-sm" name="fin_zone"></td>
                                <td><input type="text" class="form-control form-control-sm" name="fin_string"></td>
                                <td><input type="number" step="0.01" class="form-control form-control-sm" name="fin_tension_dc"></td>
                                <td><input type="number" step="0.01" class="form-control form-control-sm" name="fin_courant_dc"></td>
                                <td><input type="number" step="0.01" class="form-control form-control-sm" name="fin_tension_ac"></td>
                                <td><input type="number" step="0.01" class="form-control form-control-sm" name="fin_puissance"></td>
                                <td><input type="date" class="form-control form-control-sm" name="fin_date"></td>
                                <td><input type="text" class="form-control form-control-sm" name="fin_technicien"></td>
                                <td><select class="form-select form-select-sm" name="fin_status"><option value="ValidÃ©">ValidÃ©</option><option value="Non ValidÃ©">Non ValidÃ©</option><option value="En attente">En attente</option></select></td>
                            </tr></tbody>
                        </table>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary w-100">Enregistrer Mesures Fin de Chantier</button></div>
                </form>
              </div>
          </div>
      </div>
      {% if current_user and current_user.is_authenticated and current_user.role == "admin" %}
      <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="card rounded-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="card-title mb-0">Historique des EntrÃ©es</div>
                <div>
                    <a href="{{ url_for('telecharger_historique') }}" class="btn btn-sm btn-primary">TÃ©lÃ©charger CSV</a>
                    <a href="{{ url_for('telecharger_historique_pdf') }}" class="btn btn-sm btn-success">TÃ©lÃ©charger PDF</a>
                </div>
            </div>

            <div class="table-responsive history-table">
              <p class="text-muted small">Faites dÃ©filer horizontalement pour voir toutes les colonnes.</p>
              <table class="table align-middle table-bordered table-striped table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Utilisateur</th>
                    <th>Type Ã‰quip.</th>
                    <th>RÃ©f. Ã‰quip.</th>
                    <th>Ã‰tat Ã‰quip.</th>
                    <th>Date RÃ©cept.</th>
                    <th>Connecteur Type</th>
                    <th>QtÃ© Connect.</th>
                    <th>CÃ¢bles DC (m)</th>
                    <th>CÃ¢bles AC (m)</th>
                    <th>ProblÃ¨mes</th>
                    <th>Statut Fin</th>
                    <th>Images</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in all_lignes|default([]) %}
                  <tr>
                    <td>{{ row.date|default('') }}</td>
                    <td>{{ row.utilisateur|default('') }}</td>
                    <td>{{ row.equipement_type|default('-') }}</td>
                    <td>{{ row.equipement_reference|default('-') }}</td>
                    <td>{{ row.equipement_etat|default('-') }}</td>
                    <td>{{ row.equipement_date_reception|default('-') }}</td>
                    <td>{{ row.connecteur_type|default('-') }}</td>
                    <td>{{ row.connecteur_quantite|default('-') }}</td>
                    <td>{{ row.cables_dctires|default('-') }}</td>
                    <td>{{ row.cables_actires|default('-') }}</td>
                    <td>{{ (row.problems|default('-'))|truncate(30, True) }}</td>
                    <td>{{ row.fin_status|default('-') }}</td>
                    <td>
                      {% if row.images and row.images|length > 0 %}
                        <a href="{{ url_for('get_image', image_id=row.images[0].id) }}" target="_blank">Voir ({{ row.images|length }})</a>
                      {% else %}
                        Non
                      {% endif %}
                    </td>
                    <td class="nowrap">
                        <a href="{{ url_for('modify_history', entry_id=row.id) }}" class="btn btn-warning modify-btn">Modifier</a>
                        <form action="{{ url_for('delete_history', entry_id=row.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger modify-btn" onclick="return confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette entrÃ©e ? Cette action est irrÃ©versible.');">
                                Supprimer
                            </button>
                        </form>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="14" class="text-center text-muted">Aucune entrÃ©e dans l'historique pour le moment.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Fallback for Bootstrap CDN in case it fails to load
      if (typeof bootstrap === 'undefined') {
        document.write('<script src="{{ url_for(\'static\', filename=\'js/bootstrap.bundle.min.js\') }}"><\/script>');
        // Make sure you have a local copy of bootstrap.bundle.min.js in a static/js folder for this fallback
      }

      // JavaScript for Dynamic Photo Upload in "Ã‰quipements" Tab
      document.addEventListener('DOMContentLoaded', function() {
        const photosContainerEquipements = document.getElementById('photos-container-equipements');
        const addPhotoBtnEquipements = document.getElementById('add-photo-btn-equipements');

        if (photosContainerEquipements && addPhotoBtnEquipements) { // Check if elements exist
            function updateEquipementsRemoveButtonsVisibility() {
                const allPhotoGroups = photosContainerEquipements.querySelectorAll('.input-group');
                allPhotoGroups.forEach((group, index) => {
                    const removeBtn = group.querySelector('.remove-photo-btn-equipements');
                    if (removeBtn) {
                        // Show remove button only if there's more than one photo input
                        removeBtn.style.display = allPhotoGroups.length > 1 ? '' : 'none';
                    }
                });
            }

            addPhotoBtnEquipements.addEventListener('click', function() {
                const newInputGroup = document.createElement('div');
                newInputGroup.className = 'input-group mb-2';

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.className = 'form-control';
                fileInput.name = 'photo_chantier[]'; // Backend handles array of files
                fileInput.accept = 'image/*';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger remove-photo-btn-equipements';
                removeBtn.type = 'button';
                removeBtn.textContent = 'Supprimer';
                
                removeBtn.addEventListener('click', function() {
                    newInputGroup.remove();
                    updateEquipementsRemoveButtonsVisibility();
                });

                newInputGroup.appendChild(fileInput);
                newInputGroup.appendChild(removeBtn);
                photosContainerEquipements.appendChild(newInputGroup);
                updateEquipementsRemoveButtonsVisibility();
            });

            // Attach event listeners to any initially present remove buttons
            photosContainerEquipements.querySelectorAll('.remove-photo-btn-equipements').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.input-group').remove();
                    updateEquipementsRemoveButtonsVisibility();
                });
            });
            
            updateEquipementsRemoveButtonsVisibility(); // Initial call to set button visibility
        }

        // Tab persistence using localStorage
        var triggerTabList = [].slice.call(document.querySelectorAll('#mainTab button, #receptionSubTab button'));
        triggerTabList.forEach(function (triggerEl) {
          var tabTrigger = new bootstrap.Tab(triggerEl);

          triggerEl.addEventListener('click', function (event) {
            var storageKey = 'activeTab' + (this.closest('#mainTab') ? 'Main' : 'ReceptionSub');
            localStorage.setItem(storageKey, this.id);
          });
        });

        var activeMainTabId = localStorage.getItem('activeTabMain');
        if (activeMainTabId) {
          var activeMainTabEl = document.querySelector('#' + activeMainTabId);
          if (activeMainTabEl) {
            new bootstrap.Tab(activeMainTabEl).show();
          }
        }
        var activeReceptionSubTabId = localStorage.getItem('activeTabReceptionSub');
        if (activeReceptionSubTabId) {
          var activeReceptionSubTabEl = document.querySelector('#' + activeReceptionSubTabId);
          if (activeReceptionSubTabEl) {
            var receptionMainTab = document.querySelector('#reception-tab');
            if (receptionMainTab && receptionMainTab.classList.contains('active')) {
                 new bootstrap.Tab(activeReceptionSubTabEl).show();
            } else if (receptionMainTab && !activeMainTabId) { 
                 new bootstrap.Tab(receptionMainTab).show();
                 new bootstrap.Tab(activeReceptionSubTabEl).show();
            }
          }
        }
      });
    </script>
</body>
</html>
