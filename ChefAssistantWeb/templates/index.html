<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de Chantier - {% if session.chantier_type == 'centrale-sol' %}Centrale au Sol{% elif session.chantier_type == 'ombriere' %}Ombrière{% elif session.chantier_type == 'toiture' %}Toiture{% else %}Général{% endif %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f6f8fa; }
        .main-header {
            background: linear-gradient(90deg, #4a90e2, #357abd);
            color: white;
            padding: 1.5rem 2rem;
            /* font-size: 2rem; /* Adjusted because the logo takes up space */
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-title {
            display: flex;
            align-items: center;
            /* gap: 0.8rem; /* Gap is less needed if image has margin */
            font-size: 1.8rem; /* Slightly reduced to accommodate logo well */
            font-weight: 700;
        }
        .logout-btn {
            background: #eaf1fb;
            color: #357abd;
            border: none;
            border-radius: 0.6rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background .2s;
        }
        .logout-btn:hover {
            background: #357abd;
            color: white;
        }
        .rounded-card {
            border-radius: 1rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }
        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
        }
        .subnav .nav-link {
            border-radius: 2rem !important;
            margin-right: .5rem;
            color: #357abd;
        }
        .subnav .nav-link.active {
            background: #357abd !important;
            color: white !important;
        }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .table thead th {
            background-color: #357abd;
            color: white;
            font-size: 0.90rem; 
            white-space: nowrap;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .table td, .table th {
            vertical-align: middle !important;
            padding: 0.4rem; 
            font-size: 0.85rem; 
        }
        .nowrap {
            white-space: nowrap;
        }
        .history-table {
            font-size: 0.85rem; 
            overflow-x: auto;
        }
        .modify-btn, .delete-btn { 
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            margin-right: 0.2rem; 
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-title">
           <!-- START: Corrected TSB Logo path -->
           <img src="{{ url_for('static', filename='tsb-logo.png') }}" alt="TSB Énergie Logo" style="height: 40px; margin-right: 15px; vertical-align: middle;">
           <!-- END: Corrected TSB Logo path -->
           Suivi de Chantier - 
           {% if session.chantier_type == 'centrale-sol' %}Centrale au Sol
           {% elif session.chantier_type == 'ombriere' %}Ombrière
           {% elif session.chantier_type == 'toiture' %}Toiture
           {% else %}Général
           {% endif %}
        </div>
        <a href="{{ url_for('logout') }}"><button class="logout-btn">Déconnexion</button></a>
    </header>

    <!-- Flash Messages -->
    <div class="container-fluid pt-2">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
    </div>

    {% set is_filtering = request.args.get('filter_utilisateur') or request.args.get('filter_nom_chantier') %}
    <ul class="nav nav-tabs px-4 pt-3" id="mainTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if not is_filtering and active_tab == 'reception' %}active{% endif %}" id="reception-tab" data-bs-toggle="tab" data-bs-target="#reception" type="button" role="tab" aria-controls="reception" aria-selected="{% if not is_filtering and active_tab == 'reception' %}true{% else %}false{% endif %}">Réception du Chantier</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if not is_filtering and active_tab == 'avancement' %}active{% endif %}" id="avancement-tab" data-bs-toggle="tab" data-bs-target="#avancement" type="button" role="tab" aria-controls="avancement" aria-selected="{% if not is_filtering and active_tab == 'avancement' %}true{% else %}false{% endif %}">Avancement du Chantier</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if not is_filtering and active_tab == 'fin' %}active{% endif %}" id="fin-tab" data-bs-toggle="tab" data-bs-target="#fin" type="button" role="tab" aria-controls="fin" aria-selected="{% if not is_filtering and active_tab == 'fin' %}true{% else %}false{% endif %}">Fin du Chantier</button>
      </li>
      {% if current_user and current_user.role == "admin" %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if is_filtering or active_tab == 'history' %}active{% endif %}" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="{% if is_filtering or active_tab == 'history' %}true{% else %}false{% endif %}">Historique</button>
      </li>
      {% endif %}
    </ul>

    <div class="tab-content container-fluid pt-4" id="mainTabContent">
      <div class="tab-pane fade {% if not is_filtering and active_tab == 'reception' %}show active{% endif %}" id="reception" role="tabpanel" aria-labelledby="reception-tab">
        <div class="card rounded-card mb-3">
          <div class="card-body">
            <div class="card-title mb-4">Réception du Chantier</div>
            <ul class="nav subnav nav-pills mb-4" id="receptionSubTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="equipements-tab" data-bs-toggle="pill" data-bs-target="#equipements" type="button" role="tab" aria-controls="equipements" aria-selected="true">Équipements</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="connecteur-tab" data-bs-toggle="pill" data-bs-target="#connecteur" type="button" role="tab" aria-controls="connecteur" aria-selected="false">Connecteur</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="chemin-cable-tab" data-bs-toggle="pill" data-bs-target="#chemin-cable" type="button" role="tab" aria-controls="chemin-cable" aria-selected="false">Chemin de Câble</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="terre-tab" data-bs-toggle="pill" data-bs-target="#terre" type="button" role="tab" aria-controls="terre" aria-selected="false">Terre</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="cable-ac-tab" data-bs-toggle="pill" data-bs-target="#cable-ac" type="button" role="tab" aria-controls="cable-ac" aria-selected="false">Câble AC</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="cable-dc-tab" data-bs-toggle="pill" data-bs-target="#cable-dc" type="button" role="tab" aria-controls="cable-dc" aria-selected="false">Câble DC</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="onduleur-nombre-reception-tab" data-bs-toggle="pill" data-bs-target="#onduleur-nombre-reception-pane" type="button" role="tab" aria-controls="onduleur-nombre-reception-pane" aria-selected="false">Onduleur Nombre</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="shelter-nombre-reception-nav-tab" data-bs-toggle="pill" data-bs-target="#shelter-nombre-reception-pane" type="button" role="tab" aria-controls="shelter-nombre-reception-pane" aria-selected="false">Shelter Nombre</button>
              </li>
            </ul>
            <div class="tab-content" id="receptionSubTabContent">
              <div class="tab-pane fade show active" id="equipements" role="tabpanel" aria-labelledby="equipements-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}" enctype="multipart/form-data">
                  <input type="hidden" name="section" value="equipements">
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <label for="nom_du_chantier_reception" class="form-label">Nom du chantier</label>
                      <input type="text" class="form-control" id="nom_du_chantier_reception" name="nom_du_chantier" placeholder="Entrez le nom du chantier">
                    </div>
                  </div>
                  <div class="row mb-2 fw-bold text-center">
                    <div class="col-md-3">Type de machine</div>
                    <div class="col-md-3">Référence</div>
                    <div class="col-md-2">État</div>
                    <div class="col-md-2">Date de réception</div>
                    <div class="col-md-2">Nombre</div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-3">
                      <label for="equipement_type_1" class="form-label visually-hidden">Type de machine 1</label>
                      <select class="form-select" id="equipement_type_1" name="equipement_type_1">
                        <option value="">Sélectionner...</option>
                        <option value="Nacelle ciseau">Nacelle ciseau</option>
                        <option value="Nacelle à bras">Nacelle à bras</option>
                        <option value="Manitou">Manitou</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label for="equipement_reference_1" class="form-label visually-hidden">Référence 1</label>
                      <input type="text" class="form-control" id="equipement_reference_1" name="equipement_reference_1" placeholder="Numéro de série">
                    </div>
                    <div class="col-md-2">
                      <label for="equipement_etat_1" class="form-label visually-hidden">État 1</label>
                      <select class="form-select" id="equipement_etat_1" name="equipement_etat_1">
                        <option value="Bon état">Bon état</option>
                        <option value="À vérifier">À vérifier</option>
                        <option value="Défaillant">Défaillant</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label for="equipement_date_reception_1" class="form-label visually-hidden">Date de réception 1</label>
                      <input type="date" class="form-control" id="equipement_date_reception_1" name="equipement_date_reception_1">
                    </div>
                    <div class="col-md-2">
                      <label for="equipement_nombre_1" class="form-label visually-hidden">Nombre de Machines 1</label>
                      <input type="number" class="form-control" id="equipement_nombre_1" name="equipement_nombre_1" min="0" value="1">
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-md-3">
                      <select class="form-select" name="equipement_type_2">
                        <option value="">Sélectionner...</option>
                        <option value="Nacelle ciseau">Nacelle ciseau</option>
                        <option value="Nacelle à bras">Nacelle à bras</option>
                        <option value="Manitou">Manitou</option>
                      </select>
                    </div>
                    <div class="col-md-3"><input type="text" class="form-control" name="equipement_reference_2" placeholder="Numéro de série"></div>
                    <div class="col-md-2">
                      <select class="form-select" name="equipement_etat_2">
                        <option value="Bon état">Bon état</option><option value="À vérifier">À vérifier</option><option value="Défaillant">Défaillant</option>
                      </select>
                    </div>
                    <div class="col-md-2"><input type="date" class="form-control" name="equipement_date_reception_2"></div>
                    <div class="col-md-2"><input type="number" class="form-control" name="equipement_nombre_2" min="0" value="1"></div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-3">
                      <select class="form-select" name="equipement_type_3">
                        <option value="">Sélectionner...</option>
                        <option value="Nacelle ciseau">Nacelle ciseau</option>
                        <option value="Nacelle à bras">Nacelle à bras</option>
                        <option value="Manitou">Manitou</option>
                      </select>
                    </div>
                    <div class="col-md-3"><input type="text" class="form-control" name="equipement_reference_3" placeholder="Numéro de série"></div>
                    <div class="col-md-2">
                      <select class="form-select" name="equipement_etat_3">
                        <option value="Bon état">Bon état</option><option value="À vérifier">À vérifier</option><option value="Défaillant">Défaillant</option>
                      </select>
                    </div>
                    <div class="col-md-2"><input type="date" class="form-control" name="equipement_date_reception_3"></div>
                    <div class="col-md-2"><input type="number" class="form-control" name="equipement_nombre_3" min="0" value="1"></div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Photos du chantier</label>
                    <div id="photos-container">
                      <div class="input-group mb-2">
                        <input type="file" class="form-control" name="photo_chantier[]" accept="image/*">
                        <button class="btn btn-danger remove-photo-btn" type="button" style="display:none;">Supprimer</button>
                      </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" id="add-photo-btn">Ajouter une photo</button>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Équipements</button>
                  </div>
                </form>
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    const photosContainer = document.getElementById('photos-container');
                    const addPhotoBtn = document.getElementById('add-photo-btn');
                    function updateRemoveButtonsVisibility() {
                      const allPhotoInputs = photosContainer.querySelectorAll('.input-group');
                      allPhotoInputs.forEach((group, index) => {
                        const removeBtn = group.querySelector('.remove-photo-btn');
                        if (removeBtn) {
                          removeBtn.style.display = allPhotoInputs.length > 1 ? '' : 'none';
                        }
                      });
                    }
                    addPhotoBtn.addEventListener('click', function() {
                      const newInputGroup = document.createElement('div');
                      newInputGroup.className = 'input-group mb-2';
                      newInputGroup.innerHTML = `
                        <input type="file" class="form-control" name="photo_chantier[]" accept="image/*">
                        <button class="btn btn-danger remove-photo-btn" type="button">Supprimer</button>`;
                      photosContainer.appendChild(newInputGroup);
                      newInputGroup.querySelector('.remove-photo-btn').addEventListener('click', function() {
                        this.parentElement.remove();
                        updateRemoveButtonsVisibility();
                      });
                      updateRemoveButtonsVisibility();
                    });
                    photosContainer.querySelectorAll('.remove-photo-btn').forEach(btn => {
                      btn.addEventListener('click', function() {
                        this.parentElement.remove();
                        updateRemoveButtonsVisibility();
                      });
                    });
                    updateRemoveButtonsVisibility(); 
                  });
                </script>
              </div>
              <div class="tab-pane fade" id="connecteur" role="tabpanel" aria-labelledby="connecteur-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="connecteur">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label for="connecteur_type" class="form-label">Type de connecteur</label>
                      <input type="text" class="form-control" id="connecteur_type" name="connecteur_type">
                    </div>
                    <div class="col-md-4">
                      <label for="connecteur_quantite" class="form-label">Quantité</label>
                      <input type="number" class="form-control" id="connecteur_quantite" name="connecteur_quantite" min="0">
                    </div>
                    <div class="col-md-4">
                      <label for="connecteur_etat" class="form-label">État</label>
                      <select class="form-select" id="connecteur_etat" name="connecteur_etat">
                        <option value="Bon état">Bon état</option>
                        <option value="À vérifier">À vérifier</option>
                        <option value="Défaillant">Défaillant</option>
                      </select>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Connecteur</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="chemin-cable" role="tabpanel" aria-labelledby="chemin-cable-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="chemin_cable">
                  <div class="row mb-3">
                    <div class="col-md-3">
                      <label for="chemin_cable_type" class="form-label">Type de chemin</label>
                      <input type="text" class="form-control" id="chemin_cable_type" name="chemin_cable_type" placeholder="Ex: Fourreau, Caniveau">
                    </div>
                    <div class="col-md-3">
                      <label for="chemin_cable_longueur" class="form-label">Longueur (m)</label>
                      <input type="number" class="form-control" id="chemin_cable_longueur" name="chemin_cable_longueur" min="0" step="any">
                    </div>
                    <div class="col-md-3">
                      <label for="chemin_cable_section" class="form-label">Section (mm² ou dim.)</label>
                      <input type="text" class="form-control" id="chemin_cable_section" name="chemin_cable_section" placeholder="Ex: 50mm² ou 100x50">
                    </div>
                    <div class="col-md-3">
                      <label for="chemin_cable_profondeur" class="form-label">Profondeur enfoui. (cm)</label>
                      <input type="number" class="form-control" id="chemin_cable_profondeur" name="chemin_cable_profondeur" min="0" step="any">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Chemin Câble</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="terre" role="tabpanel" aria-labelledby="terre-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="terre">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="terre_longueur" class="form-label">Longueur Terre (m)</label>
                      <input type="number" class="form-control" id="terre_longueur" name="terre_longueur" min="0" step="any">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Terre</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="cable-ac" role="tabpanel" aria-labelledby="cable-ac-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="cable_ac">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="cableac_section" class="form-label">Section Câble AC (mm²)</label>
                      <input type="text" class="form-control" id="cableac_section" name="cableac_section">
                    </div>
                    <div class="col-md-6">
                      <label for="cableac_longueur" class="form-label">Longueur Câble AC (m)</label>
                      <input type="number" class="form-control" id="cableac_longueur" name="cableac_longueur" min="0" step="any">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Câble AC</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="cable-dc" role="tabpanel" aria-labelledby="cable-dc-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="cable_dc">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="cabledc_section" class="form-label">Section Câble DC (mm²)</label>
                      <input type="text" class="form-control" id="cabledc_section" name="cabledc_section">
                    </div>
                    <div class="col-md-6">
                      <label for="cabledc_longueur" class="form-label">Longueur Câble DC (m)</label>
                      <input type="number" class="form-control" id="cabledc_longueur" name="cabledc_longueur" min="0" step="any">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Câble DC</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="onduleur-nombre-reception-pane" role="tabpanel" aria-labelledby="onduleur-nombre-reception-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="onduleur_nombre">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="onduleur_nombre_input" class="form-label">Nombre d'Onduleurs</label>
                      <input type="number" class="form-control" id="onduleur_nombre_input" name="onduleur_nombre" min="0">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Nombre Onduleurs</button>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="shelter-nombre-reception-pane" role="tabpanel" aria-labelledby="shelter-nombre-reception-nav-tab">
                <form method="POST" action="{{ url_for('suivi_journalier') }}">
                  <input type="hidden" name="section" value="shelter_nombre_reception">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="shelter_nombre_reception_input" class="form-label">Shelter nombre</label>
                      <input type="number" class="form-control" id="shelter_nombre_reception_input" name="shelter_nombre" min="0">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer Nombre Shelter</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade {% if not is_filtering and active_tab == 'avancement' %}show active{% endif %}" id="avancement" role="tabpanel" aria-labelledby="avancement-tab">
        <div class="card rounded-card mb-3">
          <div class="card-body">
            <div class="card-title mb-4">Avancement du Chantier</div>
            <form method="POST" action="{{ url_for('suivi_journalier') }}">
              <input type="hidden" name="section" value="avancement">
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="cables_dctires" class="form-label">Câble DC tiré (m)</label>
                  <input type="number" class="form-control" id="cables_dctires" name="cables_dctires" min="0" step="any">
                </div>
                <div class="col-md-4">
                  <label for="cables_actires" class="form-label">Câble AC tiré (m)</label>
                  <input type="number" class="form-control" id="cables_actires" name="cables_actires" min="0" step="any">
                </div>
                <div class="col-md-4">
                  <label for="cables_terretires" class="form-label">Câble Terre tiré (m)</label>
                  <input type="number" class="form-control" id="cables_terretires" name="cables_terretires" min="0" step="any">
                </div>
              </div>
              {% if session.chantier_type == 'centrale-sol' or session.chantier_type == 'ombriere' %}
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="interconnexion" class="form-label">Interconnexion (ex: status, détails)</label>
                  <input type="text" class="form-control" id="interconnexion" name="interconnexion" placeholder="Détails de l'interconnexion">
                </div>
              </div>
              {% elif session.chantier_type == 'toiture' %}
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="nombre_panneaux" class="form-label">Nombre panneaux posés</label>
                  <input type="number" class="form-control" id="nombre_panneaux" name="nombre_panneaux" min="0" placeholder="Quantité">
                </div>
                <div class="col-md-6">
                  <label for="nombre_rail" class="form-label">Nombre rail posé (m)</label>
                  <input type="number" class="form-control" id="nombre_rail" name="nombre_rail" min="0" step="any" placeholder="Longueur totale en mètres">
                </div>
              </div>
              {% endif %}
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="problems" class="form-label">Problèmes rencontrés / Observations</label>
                  <textarea class="form-control" id="problems" name="problems" rows="3" placeholder="Décrivez les problèmes ou observations (si applicable)"></textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">Enregistrer Avancement</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade {% if not is_filtering and active_tab == 'fin' %}show active{% endif %}" id="fin" role="tabpanel" aria-labelledby="fin-tab">
        <div class="card rounded-card mb-3">
          <div class="card-body">
            <div class="card-title mb-4">Fin du Chantier - Tableau des Tensions</div>
            <p class="text-muted mb-3">Relevé final des tensions et mesures.</p>
            <form method="POST" action="{{ url_for('suivi_journalier') }}">
              <input type="hidden" name="section" value="fin">
              <div class="table-responsive">
                <table class="table align-middle" id="finalTensionsTable">
                  <thead>
                    <tr>
                      <th>Zone</th>
                      <th>String</th>
                      <th>Tension DC (V)</th>
                      <th>Courant DC (A)</th>
                      <th>Tension AC (V)</th>
                      <th>Puissance (W)</th>
                      <th>Date Mesure</th>
                      <th>Technicien</th>
                      <th>Statut</th>
                      <th><span class="visually-hidden">Actions</span></th>
                    </tr>
                  </thead>
                  <tbody id="finalTensionsBody">
                    <tr>
                      <td><input type="text" class="form-control form-control-sm" name="fin_zone[]"></td>
                      <td><input type="text" class="form-control form-control-sm" name="fin_string[]"></td>
                      <td><input type="number" class="form-control form-control-sm" name="fin_tension_dc[]" step="any"></td>
                      <td><input type="number" class="form-control form-control-sm" name="fin_courant_dc[]" step="any"></td>
                      <td><input type="number" class="form-control form-control-sm" name="fin_tension_ac[]" step="any"></td>
                      <td><input type="number" class="form-control form-control-sm" name="fin_puissance[]" step="any"></td>
                      <td><input type="date" class="form-control form-control-sm" name="fin_date[]"></td>
                      <td><input type="text" class="form-control form-control-sm" name="fin_technicien[]"></td>
                      <td>
                        <select class="form-select form-select-sm" name="fin_status[]">
                          <option value="Validé">Validé</option>
                          <option value="Non Validé">Non Validé</option>
                          <option value="En attente">En attente</option>
                        </select>
                      </td>
                      <td>
                        <button type="button" class="btn btn-danger btn-sm remove-row-fin" title="Supprimer" style="display:none;">✕</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-secondary btn-sm" id="addRowFinBtn">Ajouter ligne</button>
                <button type="submit" class="btn btn-primary">Enregistrer Fin de Chantier</button>
              </div>
            </form>
             <script>
              document.addEventListener('DOMContentLoaded', function() {
                const addRowBtnFin = document.getElementById('addRowFinBtn');
                const tbodyFin = document.getElementById('finalTensionsBody');
                function updateRemoveButtonsFinVisibility() {
                  const rows = tbodyFin.querySelectorAll('tr');
                  rows.forEach((row, index) => {
                    const removeBtn = row.querySelector('.remove-row-fin');
                    if (removeBtn) removeBtn.style.display = rows.length > 1 ? '' : 'none';
                  });
                }
                addRowBtnFin.addEventListener('click', function() {
                  const newRowHTML = `
                    <td><input type="text" class="form-control form-control-sm" name="fin_zone[]"></td>
                    <td><input type="text" class="form-control form-control-sm" name="fin_string[]"></td>
                    <td><input type="number" class="form-control form-control-sm" name="fin_tension_dc[]" step="any"></td>
                    <td><input type="number" class="form-control form-control-sm" name="fin_courant_dc[]" step="any"></td>
                    <td><input type="number" class="form-control form-control-sm" name="fin_tension_ac[]" step="any"></td>
                    <td><input type="number" class="form-control form-control-sm" name="fin_puissance[]" step="any"></td>
                    <td><input type="date" class="form-control form-control-sm" name="fin_date[]"></td>
                    <td><input type="text" class="form-control form-control-sm" name="fin_technicien[]"></td>
                    <td>
                      <select class="form-select form-select-sm" name="fin_status[]">
                        <option value="Validé">Validé</option><option value="Non Validé">Non Validé</option><option value="En attente">En attente</option>
                      </select>
                    </td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row-fin" title="Supprimer">✕</button></td>`;
                  const tr = tbodyFin.insertRow();
                  tr.innerHTML = newRowHTML;
                  tr.querySelector('.remove-row-fin').addEventListener('click', function() {
                    this.closest('tr').remove();
                    updateRemoveButtonsFinVisibility();
                  });
                  updateRemoveButtonsFinVisibility();
                });
                tbodyFin.querySelectorAll('.remove-row-fin').forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.closest('tr').remove();
                        updateRemoveButtonsFinVisibility();
                    });
                });
                updateRemoveButtonsFinVisibility(); 
              });
            </script>
          </div>
        </div>
      </div>

      {% if current_user and current_user.role == "admin" %}
      <div class="tab-pane fade {% if is_filtering or active_tab == 'history' %}show active{% endif %}" id="history" role="tabpanel" aria-labelledby="history-tab">
      <div class="card rounded-card mb-3">
        <div class="card-body">
          <form method="GET" action="{{ url_for('index') }}" class="mb-4 p-3 border rounded bg-light">
            <input type="hidden" name="active_tab" value="history">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="filter_utilisateur" class="form-label">Filtrer par Utilisateur</label>
                    <select name="filter_utilisateur" id="filter_utilisateur" class="form-select form-select-sm">
                        <option value="">Tous les utilisateurs</option>
                        {% for user_opt in distinct_users %}
                        <option value="{{ user_opt }}" {% if current_filter_utilisateur == user_opt %}selected{% endif %}>{{ user_opt }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filter_nom_chantier" class="form-label">Filtrer par Nom Chantier</label>
                    <select name="filter_nom_chantier" id="filter_nom_chantier" class="form-select form-select-sm">
                        <option value="">Tous les chantiers</option>
                        {% for chantier_opt in distinct_nom_chantiers %}
                        <option value="{{ chantier_opt }}" {% if current_filter_nom_chantier == chantier_opt %}selected{% endif %}>{{ chantier_opt }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
                </div>
                <div class="col-md-auto">
                    <a href="{{ url_for('index', active_tab='history') }}" class="btn btn-sm btn-secondary">Réinitialiser</a>
                </div>
            </div>
          </form>
          <div class="d-flex justify-content-between align-items-center mb-3"> 
            <div class="card-title mb-0">Historique des Entrées</div>
            <div>
                <a href="{{ url_for('telecharger_historique', filter_utilisateur=current_filter_utilisateur, filter_nom_chantier=current_filter_nom_chantier) }}" class="btn btn-sm btn-primary">Télécharger CSV Filtré</a>
                <a href="{{ url_for('telecharger_historique_pdf', filter_utilisateur=current_filter_utilisateur, filter_nom_chantier=current_filter_nom_chantier) }}" class="btn btn-sm btn-success">Télécharger PDF Filtré</a>
            </div>
          </div>
          
          <h5 class="mt-4 mb-2">Réception du Chantier</h5>
          <div class="table-responsive history-table mb-4">
            <p class="text-muted small">Faites défiler horizontalement pour voir toutes les colonnes.</p>
            <table class="table align-middle table-bordered table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Utilisateur</th>
                  <th>Nom Chantier</th>
                  <th>Type Équip.</th>
                  <th>Réf. Équip.</th>
                  <th>État Équip.</th>
                  <th>Date Récept. Équip.</th>
                  <th>Nb Équip. 1</th>
                  <th>Type Conn.</th>
                  <th>Qté Conn.</th>
                  <th>État Conn.</th>
                  <th>Type Ch. Câble</th>
                  <th>Long. Ch. Câble</th>
                  <th>Sect. Ch. Câble</th>
                  <th>Prof. Ch. Câble</th>
                  <th>Long. Terre</th>
                  <th>Sect. AC</th>
                  <th>Long. AC</th>
                  <th>Sect. DC</th>
                  <th>Long. DC</th>
                  <th>Nb Onduleur</th> 
                  <th>Nb Shelter</th>
                  <th>Images</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for row in all_lignes|default([]) %}
                  {% if row.equipement_type or row.connecteur_type or row.chemin_cable_type or row.terre_longueur or row.cableac_section or row.cabledc_section or row.onduleur_nombre or row.shelter_nombre %}
                  <tr>
                    <td>{{ row.date|default('') }}</td>
                    <td>{{ row.utilisateur|default('') }}</td>
                    <td>{{ row.nom_du_chantier|default('') }}</td>
                    <td>{{ row.equipement_type|default('') }}</td>
                    <td>{{ row.equipement_reference|default('') }}</td>
                    <td>{{ row.equipement_etat|default('') }}</td>
                    <td>{{ row.equipement_date_reception|default('') }}</td>
                    <td>{{ row.equipement_nombre_1|default('') }}</td> 
                    <td>{{ row.connecteur_type|default('') }}</td>
                    <td>{{ row.connecteur_quantite|default('') }}</td>
                    <td>{{ row.connecteur_etat|default('') }}</td>
                    <td>{{ row.chemin_cable_type|default('') }}</td>
                    <td>{{ row.chemin_cable_longueur|default('') }}</td>
                    <td>{{ row.chemin_cable_section|default('') }}</td>
                    <td>{{ row.chemin_cable_profondeur|default('') }}</td>
                    <td>{{ row.terre_longueur|default('') }}</td>
                    <td>{{ row.cableac_section|default('') }}</td>
                    <td>{{ row.cableac_longueur|default('') }}</td>
                    <td>{{ row.cabledc_section|default('') }}</td>
                    <td>{{ row.cabledc_longueur|default('') }}</td>
                    <td>{{ row.onduleur_nombre|default('') }}</td> 
                    <td>{{ row.shelter_nombre|default('') }}</td>
                    <td>
                      {% if row.images %}
                        {% for img in row.images %}
                          <a href="{{ url_for('get_image', image_id=img.id) }}" target="_blank" class="badge bg-info text-dark">{{ img.filename|truncate(15) }}</a>
                        {% endfor %}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td class="nowrap">
                      <a href="{{ url_for('modify_history', entry_id=row.id) }}" class="btn btn-warning modify-btn">Modifier</a>
                      <form action="{{ url_for('delete_history', entry_id=row.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer cette entrée ?');">
                        <button type="submit" class="btn btn-danger delete-btn">Supprimer</button>
                      </form>
                    </td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <h5 class="mt-4 mb-2">Avancement du Chantier</h5>
          <div class="table-responsive history-table mb-4">
            <p class="text-muted small">Faites défiler horizontalement pour voir toutes les colonnes.</p>
            <table class="table align-middle table-bordered table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Utilisateur</th>
                  <th>Type Chantier</th>
                  <th>Câble DC (m)</th>
                  <th>Câble AC (m)</th>
                  <th>Câble Terre (m)</th>
                  <th>Interconnexion</th>
                  <th>Nb Panneaux</th>
                  <th>Nb Rails (m)</th>
                  <th>Problèmes</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for row in all_lignes|default([]) %}
                {% if row.cables_dctires or row.cables_actires or row.cables_terretires or row.problems or row.interconnexion or row.nombre_panneaux or row.nombre_rail %}
                <tr>
                  <td>{{ row.date|default('') }}</td>
                  <td>{{ row.utilisateur|default('') }}</td>
                  <td>{{ row.chantier_type|default('N/A') }}</td>
                  <td>{{ row.cables_dctires|default('') }}</td>
                  <td>{{ row.cables_actires|default('') }}</td>
                  <td>{{ row.cables_terretires|default('') }}</td>
                  <td>
                    {% if row.chantier_type == 'centrale-sol' or row.chantier_type == 'ombriere' %}
                      {{ row.interconnexion|default('-') }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if row.chantier_type == 'toiture' %}
                      {{ row.nombre_panneaux|default('-') }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if row.chantier_type == 'toiture' %}
                      {{ row.nombre_rail|default('-') }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ row.problems|default('') }}</td>
                  <td class="nowrap">
                    <a href="{{ url_for('modify_history', entry_id=row.id) }}" class="btn btn-warning modify-btn">Modifier</a>
                    <form action="{{ url_for('delete_history', entry_id=row.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer cette entrée ?');">
                      <button type="submit" class="btn btn-danger delete-btn">Supprimer</button>
                    </form>
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <h5 class="mt-4 mb-2">Fin du Chantier</h5>
          <div class="table-responsive history-table mb-4">
            <p class="text-muted small">Faites défiler horizontalement pour voir toutes les colonnes.</p>
            <table class="table align-middle table-bordered table-striped">
              <thead>
                <tr>
                  <th>Date Entrée</th>
                  <th>Utilisateur</th>
                  <th>Zone</th>
                  <th>String</th>
                  <th>Tension DC (V)</th>
                  <th>Courant DC (A)</th>
                  <th>Tension AC (V)</th>
                  <th>Puissance (W)</th>
                  <th>Date Mesure</th>
                  <th>Technicien</th>
                  <th>Statut</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for row in all_lignes|default([]) %}
                {% if row.fin_zone or row.fin_string %} 
                <tr>
                  <td>{{ row.date|default('') }}</td>
                  <td>{{ row.utilisateur|default('') }}</td>
                  <td>{{ row.fin_zone|default('') }}</td>
                  <td>{{ row.fin_string|default('') }}</td>
                  <td>{{ row.fin_tension_dc|default('') }}</td>
                  <td>{{ row.fin_courant_dc|default('') }}</td>
                  <td>{{ row.fin_tension_ac|default('') }}</td>
                  <td>{{ row.fin_puissance|default('') }}</td>
                  <td>{{ row.fin_date|default('') }}</td>
                  <td>{{ row.fin_technicien|default('') }}</td>
                  <td>{{ row.fin_status|default('') }}</td>
                  <td class="nowrap">
                    <a href="{{ url_for('modify_history', entry_id=row.id) }}" class="btn btn-warning modify-btn">Modifier</a>
                    <form action="{{ url_for('delete_history', entry_id=row.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer cette entrée ?');">
                      <button type="submit" class="btn btn-danger delete-btn">Supprimer</button>
                    </form>
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %} 
    </div> 

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
