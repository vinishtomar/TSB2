<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Chantier TSB Energie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5; /* Lighter grey for overall background */
        }
        .navbar {
            background-color: #004A99; /* TSB Energie Blue */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand, .nav-link, .navbar-text {
            color: #ffffff !important;
        }
        .nav-link:hover {
            color: #e0e0e0 !important;
        }
        .rounded-card {
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background-color: #ffffff;
            margin-bottom: 2rem;
        }
        .card-title {
            font-weight: bold;
            color: #004A99; /* TSB Energie Blue */
            border-bottom: 2px solid #FFD700; /* TSB Energie Yellow/Gold */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .nav-tabs .nav-link {
            color: #004A99;
            border: 1px solid transparent;
            border-top-left-radius: .25rem;
            border-top-right-radius: .25rem;
        }
        .nav-tabs .nav-link.active {
            color: #003366; /* Darker Blue for active tab */
            background-color: #e9ecef;
            border-color: #dee2e6 #dee2e6 #e9ecef;
            border-bottom: 3px solid #FFD700; /* TSB Energie Yellow/Gold */
        }
        .form-label {
            font-weight: 500;
            color: #343a40;
        }
        .btn-primary {
            background-color: #004A99;
            border-color: #004A99;
        }
        .btn-primary:hover {
            background-color: #003366;
            border-color: #003366;
        }
        .btn-danger { /* Standard danger color */
             /* background-color: #C00000; Red TSB */
             /* border-color: #C00000; */
        }
        .btn-success { /* Standard success color */
            /* background-color: #00B050; Green TSB */
            /* border-color: #00B050; */
        }
        .table-primary {
            background-color: #004A99 !important; /* For table header */
            color: white;
        }
        .alert {
            border-radius: .25rem;
        }
        .logout-btn {
            color: #FFD700 !important; /* TSB Gold for logout */
        }
        .form-section-title {
            color: #003366;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-tools me-2"></i>TSB Energie - Suivi de Chantier
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <span class="navbar-text me-3">
                                Bienvenue, {{ current_user.id }} ({{ current_user.role }})
                            </span>
                        </li>
                        {% if current_user.role == 'admin' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_panel') }}">Panneau Admin</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_view_all_suivi_journalier') }}">Toutes les Entrées (Admin)</a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link logout-btn" href="{{ url_for('logout') }}">Déconnexion <i class="fas fa-sign-out-alt"></i></a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">Connexion</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Main Form for Suivi Journalier -->
        <div class="card rounded-card mb-4">
            <div class="card-body">
                <h3 class="card-title">Nouvelle Entrée de Suivi Journalier</h3>
                <form method="POST" action="{{ url_for('add_suivi_journalier_entry') }}" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {# If using Flask-WTF for CSRF protection: <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nom_chantier" class="form-label">Nom du Chantier <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nom_chantier" name="nom_chantier" required>
                            <div class="invalid-feedback">Le nom du chantier est requis.</div>
                        </div>
                         <div class="col-md-6">
                            <label for="date_entree" class="form-label">Date de l'entrée</label>
                            {# Assuming 'datetime' is passed to the template context for datetime.now() #}
                            <input type="text" class="form-control" id="date_entree" name="date" 
                                   value="{{ datetime.now().strftime('%Y-%m-%d %H:%M') if datetime else '' }}" readonly>
                            <small class="form-text text-muted">Généré automatiquement.</small>
                        </div>
                    </div>

                    <!-- Navigation Tabs for Form Sections -->
                    <ul class="nav nav-tabs mb-4" id="formTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="form-equipement-tab" data-bs-toggle="tab" data-bs-target="#form-equipement" type="button" role="tab" aria-controls="form-equipement" aria-selected="true">Équipement</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="form-connecteur-tab" data-bs-toggle="tab" data-bs-target="#form-connecteur" type="button" role="tab" aria-controls="form-connecteur" aria-selected="false">Connecteur</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="form-chemincable-tab" data-bs-toggle="tab" data-bs-target="#form-chemincable" type="button" role="tab" aria-controls="form-chemincable" aria-selected="false">Chemin de câble</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="form-terre-ac-dc-tab" data-bs-toggle="tab" data-bs-target="#form-terre-ac-dc" type="button" role="tab" aria-controls="form-terre-ac-dc" aria-selected="false">Terre & Câbles</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="form-avancement-tab" data-bs-toggle="tab" data-bs-target="#form-avancement" type="button" role="tab" aria-controls="form-avancement" aria-selected="false">Avancement & Conditions</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="form-fin-tab" data-bs-toggle="tab" data-bs-target="#form-fin" type="button" role="tab" aria-controls="form-fin" aria-selected="false">Mesures Finales</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="form-photos-tab" data-bs-toggle="tab" data-bs-target="#form-photos" type="button" role="tab" aria-controls="form-photos" aria-selected="false">Photos Générales</button></li>
                    </ul>

                    <!-- Tab Content for Form Sections -->
                    <div class="tab-content" id="formTabContent">
                        <!-- Equipment Tab Pane -->
                        <div class="tab-pane fade show active" id="form-equipement" role="tabpanel" aria-labelledby="form-equipement-tab">
                            <h5 class="form-section-title">Informations Équipement</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Type de Machine</label>
                                    <select class="form-select" name="equipement_type">
                                        <option value="">Sélectionner...</option>
                                        <option value="Onduleur">Onduleur</option>
                                        <option value="Transformateur">Transformateur</option>
                                        <option value="Panneau">Panneau</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Référence</label>
                                    <input type="text" class="form-control" name="equipement_reference">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">État</label>
                                    <select class="form-select" name="equipement_etat">
                                        <option value="">Sélectionner...</option>
                                        <option value="Neuf">Neuf</option>
                                        <option value="Bon">Bon</option>
                                        <option value="Moyen">Moyen</option>
                                        <option value="Mauvais">Mauvais</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Date de Réception</label>
                                    <input type="date" class="form-control" name="equipement_date_reception">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Nombre (Cat. 1)</label>
                                    <input type="text" class="form-control" name="equipement_nombre_1" placeholder="ex: 5">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Nombre (Cat. 2)</label>
                                    <input type="text" class="form-control" name="equipement_nombre_2" placeholder="ex: 10">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Nombre (Cat. 3)</label>
                                    <input type="text" class="form-control" name="equipement_nombre_3" placeholder="ex: 2">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Nombre de Shelter</label>
                                    <input type="number" class="form-control" name="shelter_nombre" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Connector Tab Pane -->
                        <div class="tab-pane fade" id="form-connecteur" role="tabpanel" aria-labelledby="form-connecteur-tab">
                            <h5 class="form-section-title">Informations Connecteur</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Type de Connecteur</label>
                                    <select class="form-select" name="connecteur_type">
                                        <option value="">Sélectionner...</option>
                                        <option value="MC4">MC4</option>
                                        <option value="MC4-EVO2">MC4-EVO2</option>
                                        <option value="T4">T4</option>
                                        <option value="Sunclix">Sunclix</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quantité</label>
                                    <input type="text" class="form-control" name="connecteur_quantite">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">État</label>
                                    <select class="form-select" name="connecteur_etat">
                                        <option value="">Sélectionner...</option>
                                        <option value="Neuf">Neuf</option>
                                        <option value="Bon">Bon</option>
                                        <option value="Moyen">Moyen</option>
                                        <option value="Mauvais">Mauvais</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Cable Path Tab Pane -->
                        <div class="tab-pane fade" id="form-chemincable" role="tabpanel" aria-labelledby="form-chemincable-tab">
                            <h5 class="form-section-title">Informations Chemin de Câble</h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Longueur (m)</label>
                                    <input type="text" class="form-control" name="chemin_cable_longueur">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" name="chemin_cable_type">
                                        <option value="">Sélectionner...</option>
                                        <option value="Dalle">Dalle</option>
                                        <option value="Grillage">Grillage</option>
                                        <option value="Tube">Tube</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Section</label>
                                    <input type="text" class="form-control" name="chemin_cable_section">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Profondeur (cm)</label>
                                    <input type="text" class="form-control" name="chemin_cable_profondeur">
                                </div>
                            </div>
                        </div>

                        <!-- Ground & Cables Tab Pane -->
                        <div class="tab-pane fade" id="form-terre-ac-dc" role="tabpanel" aria-labelledby="form-terre-ac-dc-tab">
                            <h5 class="form-section-title">Mise à la Terre & Câbles AC/DC</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Longueur Terre (m)</label>
                                    <input type="text" class="form-control" name="terre_longueur">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Section Câble AC (mm²)</label>
                                    <input type="text" class="form-control" name="cableac_section">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Longueur Câble AC (m)</label>
                                    <input type="text" class="form-control" name="cableac_longueur">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Section Câble DC (mm²)</label>
                                    <input type="text" class="form-control" name="cabledc_section">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Longueur Câble DC (m)</label>
                                    <input type="text" class="form-control" name="cabledc_longueur">
                                </div>
                            </div>
                        </div>

                        <!-- Progress & Conditions Tab Pane -->
                        <div class="tab-pane fade" id="form-avancement" role="tabpanel" aria-labelledby="form-avancement-tab">
                            <h5 class="form-section-title">Avancement des Travaux & Conditions</h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Câbles DC Tirés (m)</label>
                                    <input type="text" class="form-control" name="cables_dctires">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Câbles AC Tirés (m)</label>
                                    <input type="text" class="form-control" name="cables_actires">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Câbles Terre Tirés (m)</label>
                                    <input type="text" class="form-control" name="cables_terretires">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Conditions Météo</label>
                                    <select class="form-select" name="weather_conditions">
                                        <option value="">Sélectionner...</option>
                                        <option value="Ensoleillé">Ensoleillé</option>
                                        <option value="Nuageux">Nuageux</option>
                                        <option value="Pluvieux">Pluvieux</option>
                                        <option value="Venteux">Venteux</option>
                                        <option value="Orageux">Orageux</option>
                                        <option value="Neige">Neige</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Température (°C)</label>
                                    <input type="number" class="form-control" name="temperature" step="0.1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Heures de Travail</label>
                                    <input type="number" class="form-control" name="work_hours" step="0.5" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Nombre de Personnel</label>
                                    <input type="number" class="form-control" name="staff_count" min="0">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Problèmes Rencontrés / Observations</label>
                                    <textarea class="form-control" name="problems" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Final Measurements Tab Pane -->
                        <div class="tab-pane fade" id="form-fin" role="tabpanel" aria-labelledby="form-fin-tab">
                            <h5 class="form-section-title">Tableau des Tensions Finales et Mesures</h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Zone</label>
                                    <input type="text" class="form-control" name="fin_zone">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">String</label>
                                    <input type="text" class="form-control" name="fin_string">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Tension DC (V)</label>
                                    <input type="text" class="form-control" name="fin_tension_dc">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Courant DC (A)</label>
                                    <input type="text" class="form-control" name="fin_courant_dc">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Tension AC (V)</label>
                                    <input type="text" class="form-control" name="fin_tension_ac">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Puissance (W)</label>
                                    <input type="text" class="form-control" name="fin_puissance">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Date de Mesure</label>
                                    <input type="datetime-local" class="form-control" name="fin_date">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Technicien</label>
                                    <input type="text" class="form-control" name="fin_technicien">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Status Final</label>
                                    <select class="form-select" name="fin_status">
                                        <option value="">Sélectionner...</option>
                                        <option value="Conforme">Conforme</option>
                                        <option value="Non Conforme">Non Conforme</option>
                                        <option value="À Vérifier">À Vérifier</option>
                                        <option value="En Attente">En Attente</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- General Photos Tab Pane -->
                        <div class="tab-pane fade" id="form-photos" role="tabpanel" aria-labelledby="form-photos-tab">
                            <h5 class="form-section-title">Photos Générales du Chantier</h5>
                             <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Vous pouvez ajouter plusieurs photos.
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ajouter des photos (multiples possibles)</label>
                                <input type="file" class="form-control" name="photo_chantier[]" multiple accept="image/*,.png,.jpg,.jpeg,.gif">
                                <small class="form-text text-muted">Extensions autorisées: .png, .jpg, .jpeg, .gif. Taille max: 16MB total.</small>
                            </div>
                        </div>
                    </div> <!-- End Tab Content -->

                    <div class="mt-4 pt-3 border-top">
                        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Enregistrer l'Entrée</button>
                        <button type="reset" class="btn btn-secondary btn-lg"><i class="fas fa-undo me-2"></i>Réinitialiser le Formulaire</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- History Section -->
        <div class="card rounded-card">
            <div class="card-body">
                <h3 class="card-title">Historique des Entrées</h3>
                
                <div class="row mb-3 align-items-end">
                    <div class="col-md-4">
                        <label for="searchHistoryInput" class="form-label">Recherche rapide</label>
                        <input type="text" class="form-control" id="searchHistoryInput" placeholder="Filtrer par mot-clé...">
                    </div>
                    <div class="col-md-3">
                        <label for="filterStartDate" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="filterStartDate" title="Date de début">
                    </div>
                    <div class="col-md-3">
                        <label for="filterEndDate" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="filterEndDate" title="Date de fin">
                    </div>
                    <div class="col-md-2 d-grid">
                         <button class="btn btn-outline-secondary" type="button" id="applyDateFilterButton" title="Appliquer filtre date"><i class="fas fa-filter me-1"></i>Filtrer</button>
                    </div>
                </div>

                <div class="mb-3">
                    <a href="{{ url_for('telecharger_historique_csv') }}" class="btn btn-success">
                        <i class="fas fa-file-csv me-1"></i> Télécharger CSV
                    </a>
                    {% if current_user.role == 'admin' %}
                    <a href="{{ url_for('telecharger_historique_pdf') }}" class="btn btn-danger">
                        <i class="fas fa-file-pdf me-1"></i> Télécharger PDF (Admin)
                    </a>
                    {% endif %}
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered" id="historyTable">
                        <thead class="table-primary">
                            <tr>
                                <th>Date</th>
                                <th>Utilisateur</th>
                                <th>Chantier</th>
                                <th>Type Équip.</th>
                                <th>Réf. Équip.</th>
                                <th>Problèmes (extrait)</th>
                                <th>Statut Final</th>
                                <th>Photos</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if entries %}
                                {% for entry in entries %}
                                <tr data-entry-id="{{ entry.id }}">
                                    <td>{{ entry.date }}</td>
                                    <td>{{ entry.utilisateur }}</td>
                                    <td>{{ entry.nom_chantier or 'N/A' }}</td>
                                    <td>{{ entry.equipement_type or '' }}</td>
                                    <td>{{ entry.equipement_reference or '' }}</td>
                                    <td title="{{ entry.problems }}">{{ (entry.problems[:30] + '...') if entry.problems and entry.problems|length > 30 else (entry.problems or '') }}</td>
                                    <td>{{ entry.fin_status or '' }}</td>
                                    <td>
                                        {% if entry.images %}
                                            <span class="badge bg-info">{{ entry.images|length }} image(s)</span>
                                        {% else %}
                                            <span class="badge bg-secondary">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('modify_history', entry_id=entry.id) }}" class="btn btn-warning" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if current_user.role == 'admin' %}
                                            <button type="button" class="btn btn-danger" title="Supprimer" onclick="confirmDeleteEntry({{ entry.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                            {% if entry.images and entry.images|length > 0 %}
                                            <button type="button" class="btn btn-info" title="Voir Images" onclick="viewEntryImages({{ entry.id }})">
                                                <i class="fas fa-images"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center">Aucune entrée dans l'historique.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                 <div class="text-muted mt-2 text-end">
                    <small><i class="fas fa-arrows-alt-h"></i> Faites défiler horizontalement si nécessaire</small>
                </div>


                <!-- Pagination -->
                {% if pagination and pagination.pages > 1 %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                            <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) if pagination.has_prev else '#'}}">Précédent</a>
                        </li>
                        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                <li class="page-item {{ 'active' if page_num == pagination.page }}">
                                    <a class="page-link" href="{{ url_for('index', page=page_num, start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                            <a class="page-link" href="{{ url_for('index', page=pagination.next_num, start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) if pagination.has_next else '#'}}">Suivant</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div> <!-- End Container -->

    <!-- Image Viewing Modal -->
    <div class="modal fade" id="viewImagesModal" tabindex="-1" aria-labelledby="viewImagesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered"> {# modal-xl for larger modal #}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewImagesModalLabel">Images de l'Entrée</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modalImageCarouselContainer">
            {# Carousel will be dynamically injected here #}
            <p class="text-center">Chargement des images...</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden form for deletion -->
    <form id="deleteEntryForm" method="POST" style="display:none;">
        {# If using Flask-WTF for CSRF protection: <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
    </form>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Standard Bootstrap form validation
        (function () {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
        })();

        // History table client-side search
        const searchHistoryInput = document.getElementById('searchHistoryInput');
        if (searchHistoryInput) {
            searchHistoryInput.addEventListener('keyup', function() {
                const searchTerm = searchHistoryInput.value.toLowerCase();
                const historyTableRows = document.querySelectorAll('#historyTable tbody tr');
                historyTableRows.forEach(row => {
                    const rowText = row.textContent.toLowerCase();
                    row.style.display = rowText.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
        // Date range filter
        document.getElementById('applyDateFilterButton')?.addEventListener('click', function() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            let url = new URL("{{ url_for('index') }}", window.location.origin); // Base URL for index
            url.searchParams.delete('page'); // Reset to page 1 for new filter

            if (startDate) url.searchParams.set('start_date', startDate);
            if (endDate) url.searchParams.set('end_date', endDate);
            
            window.location.href = url.toString();
        });

        // Delete entry confirmation
        function confirmDeleteEntry(entryId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée? Cette action est irréversible.')) {
                const form = document.getElementById('deleteEntryForm');
                form.action = `/delete-history/${entryId}`; 
                // Important: For CSRF protection with Flask-WTF, ensure the token is in this form.
                // Example if you have a global csrf_token() function in Jinja:
                // const csrfInput = form.querySelector('input[name="csrf_token"]');
                // if (!csrfInput) { // Add CSRF token if not present
                //    const token = document.createElement('input');
                //    token.type = 'hidden';
                //    token.name = 'csrf_token';
                //    token.value = '{{ csrf_token() if csrf_token else "" }}'; // Get from global or meta tag
                //    form.appendChild(token);
                // }
                form.submit();
            }
        }

        // View entry images in a modal
        async function viewEntryImages(entryId) {
            const modalImageCarouselContainer = document.getElementById('modalImageCarouselContainer');
            const modalTitle = document.getElementById('viewImagesModalLabel');
            modalTitle.textContent = `Images de l'Entrée #${entryId}`;
            modalImageCarouselContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
            
            const imageModal = new bootstrap.Modal(document.getElementById('viewImagesModal'));
            imageModal.show();

            try {
                // This requires an API endpoint to fetch image IDs for a given entry.
                // Let's assume your `SuiviJournalier` object (named `entry` in the loop)
                // has an `images` attribute which is a list of `SuiviJournalierImage` objects,
                // and each image object has an `id`.
                // We can't directly access Python objects here. So, an API is best.
                // For now, as a simplified approach, we'll just show a message.
                // If you can pass the image IDs to the JS (e.g., via data attributes), that's another way.

                // Placeholder: You would fetch actual image IDs/data here.
                // For example: const response = await fetch(`/api/entry/${entryId}/images`);
                // const imageData = await response.json(); // Assuming it returns a list like [{id: 1, filename: 'foo.jpg'}, ...]
                
                // Simulating finding the entry from the server-rendered list (not ideal but for demo)
                let imagesHtml = '<p class="text-center text-muted">Aucune image trouvée ou la fonctionnalité d\'affichage d\'images n\'est pas encore entièrement implémentée via API.</p>';
                
                {% if entries %}
                const allEntries = {{ entries|tojson|safe }}; // Pass entries as JSON to JS
                const currentEntry = allEntries.find(e => e.id === entryId);

                if (currentEntry && currentEntry.images && currentEntry.images.length > 0) {
                    imagesHtml = `<div id="carouselEntryImages${entryId}" class="carousel slide" data-bs-ride="carousel">
                                    <div class="carousel-indicators">`;
                    currentEntry.images.forEach((img, index) => {
                        imagesHtml += `<button type="button" data-bs-target="#carouselEntryImages${entryId}" data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}" aria-current="${index === 0 ? 'true' : 'false'}" aria-label="Image ${index + 1}"></button>`;
                    });
                    imagesHtml += `   </div>
                                    <div class="carousel-inner">`;
                    currentEntry.images.forEach((img, index) => {
                        imagesHtml += `<div class="carousel-item ${index === 0 ? 'active' : ''}">
                                         <img src="/image/${img.id}" class="d-block w-100" alt="${img.filename || 'Image ' + (index+1) }" style="max-height: 70vh; object-fit: contain;">
                                         <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 p-2 rounded">
                                           <h5>${img.filename || 'Image ' + (index+1)}</h5>
                                         </div>
                                       </div>`;
                    });
                    imagesHtml += `   </div>
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselEntryImages${entryId}" data-bs-slide="prev">
                                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                      <span class="visually-hidden">Précédent</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carouselEntryImages${entryId}" data-bs-slide="next">
                                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                      <span class="visually-hidden">Suivant</span>
                                    </button>
                                  </div>`;
                }
                {% endif %}
                
                modalImageCarouselContainer.innerHTML = imagesHtml;

            } catch (error) {
                console.error("Erreur lors de la construction du carrousel d'images:", error);
                modalImageCarouselContainer.innerHTML = '<p class="text-center text-danger">Impossible de charger les images. Une erreur est survenue.</p>';
            }
        }

        // Ensure `datetime` is available if used in the template for default date
        // This would typically be passed from Flask: `render_template('index.html', datetime=datetime)`
        // If not, the value for the date input will be empty.
    </script>
</body>
</html>
